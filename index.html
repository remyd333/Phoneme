<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trouver les Sons - Phon√®mes</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: 'Comic Sans MS', cursive, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        overflow: hidden; user-select: none;
    }
    #gameContainer {
        width: 100vw; height: 100vh; position: relative;
        max-width: 1200px; margin: 0 auto;
    }
    #menuScreen, #levelScreen, #gameScreen, #endScreen, #phonemeSelectScreen {
        position: absolute; width: 100%; height: 100%;
        display: flex; flex-direction: column; align-items: center;
        justify-content: center; color: white; text-align: center;
        padding: 20px;
    }
    h1 { font-size: 4em; margin-bottom: 30px; text-shadow: 3px 3px 6px rgba(0,0,0,0.5); }
    h2 { font-size: 3em; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    button {
        font-size: 2em; padding: 20px 50px; margin: 15px;
        background: #FFD93D; color: #333; border: none;
        border-radius: 50px; cursor: pointer; transition: transform 0.2s;
        font-weight: bold;
    }
    button:hover { transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .level-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 30px; max-width: 900px; padding: 20px;
    }
    .level-btn {
        background: #4CAF50; color: white; padding: 40px; font-size: 2.5em;
    }
    #gameArea {
        width: 100%; height: 70%; position: relative; overflow: hidden;
    }
    #ground {
        position: absolute; bottom: 0; width: 100%; height: 120px;
        background: #8B4513;
    }
    #character {
        position: absolute; width: 80px; height: 100px; bottom: 120px; left: 80px;
        background: transparent;
        border-radius: 15px; transition: bottom 0.3s;
    }
    #character::before {
        content: var(--character-face, "üòê");
        font-size: 70px; position: absolute; top: -5px; left: 5px;
    }
    .obstacle {
        position: absolute; width: 200px; height: 220px; bottom: 120px;
        right: -200px; background: transparent;
        border-radius: 20px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .obstacle-image {
        width: 120px; height: 120px; background: white; border-radius: 15px;
        display: flex; align-items: center; justify-content: center; font-size: 5em;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .masked-word {
        margin-top: 10px; font-size: 2.5em; font-weight: bold; color: white;
        font-family: 'Courier New', monospace;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
    }
    /* UI MODIFI√âE */
    #ui {
        position: absolute; 
        top: 20px; 
        left: 20px; 
        right: 280px;
        display: flex; 
        justify-content: flex-start; /* Aligner √† gauche */
        color: white;
        font-size: 1.8em; 
        font-weight: bold;
        gap: 30px; /* Espace entre les √©l√©ments */
    }
    /* NOUVEAU COMPTEUR DE NIVEAU en dessous */
    #levelCounter {
        position: absolute;
        top: 70px; /* En dessous des vies */
        left: 20px;
        color: white;
        font-size: 1.8em;
        font-weight: bold;
    }
    #phonemeDisplay {
        position: absolute; top: 30px; left: 50%; transform: translateX(-50%);
        font-size: 5em; color: #FFD93D; text-shadow: 4px 4px 8px rgba(0,0,0,0.7);
    }
    #instruction {
        display: none;
    }
    #controlArea {
        position: absolute; bottom: 0; width: 100%; height: 30%;
        background: transparent;
        display: flex; flex-direction: column;
        align-items: center; justify-content: space-around;
    }
    #answerButtons { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
    .answer-btn { padding: 20px 40px; font-size: 2em; min-width: 120px; }
    .answer-btn.correct { background: #4CAF50; }
    .answer-btn.wrong { background: #F44336; }
    .answer-btn.none { background: #666; }
    #pauseBtn, #menuBtn, #musicBtn {
        position: absolute; top: 20px; padding: 15px 30px;
        font-size: 1.5em; z-index: 100; width: 170px;
        text-align: center;
    }
    #pauseBtn { right: 20px; }
    #menuBtn { right: 210px; background: #2196F3; }
    #musicBtn { right: 400px; background: #9C27B0; }
    #feedback {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        font-size: 5em; color: #FFD93D; font-weight: bold; text-shadow: 4px 4px 8px rgba(0,0,0,0.7);
        animation: bounce 0.5s; z-index: 20;
    }
    @keyframes bounce {
        0%, 100% { transform: translate(-50%, -50%) scale(1); }
        50% { transform: translate(-50%, -50%) scale(1.3); }
    }
    .stars { font-size: 3em; margin: 20px; }
    .hidden { display: none !important; }
</style>
</head>
<body>
<div id="gameContainer">
    <!-- √âcran Menu -->
    <div id="menuScreen">
        <h1>üîç Trouver les Sons üéÆ</h1>
        <p style="font-size: 1.8em; margin-bottom: 40px;">√âcoute bien et aide l'explorateur !</p>
        <button onclick="showLevels()">Jouer</button>
    </div>

    <!-- √âcran S√©lection Mode -->
    <div id="levelScreen" class="hidden">
        <h2>Choisis un mode :</h2>
        <button onclick="showPhonemeSelection()">üìö Niveau 1 (un son)</button>
        <button onclick="startGame(null, 'random')" style="background:#FF9800;">üéØ Niveau 2 (sons al√©atoires)</button>
        <button onclick="startGame(null, 'expert')" style="background:#F44336;">üî• Niveau 3 (expert)</button>
        <button onclick="showMenu()" style="background:#999; margin-top: 30px;">‚Üê Retour au menu</button>
    </div>

    <!-- √âcran S√©lection Phon√®me (Niveau 1) -->
    <div id="phonemeSelectScreen" class="hidden">
        <h2>Choisis le son √† apprendre :</h2>
        <div class="level-grid" id="phonemeGrid"></div>
        <button onclick="showLevels()" style="background:#999; margin-top: 30px;">‚Üê Retour</button>
    </div>

    <!-- √âcran Jeu -->
    <div id="gameScreen" class="hidden">
        <div id="gameArea">
            <div id="ground"></div>
            <div id="character"></div>
            <div id="phonemeDisplay"></div>
            <div id="instruction"></div>
        </div>
        <div id="controlArea">
            <div id="answerButtons"></div>
        </div>
        
        <!-- UI MODIFI√âE : Vies et Score seulement -->
        <div id="ui">
            <div>Vies: <span id="lives">3</span> ‚ù§Ô∏è</div>
            <div>Score: <span id="score">0</span> ‚≠ê</div>
        </div>
        
        <!-- NOUVEAU COMPTEUR DE NIVEAU -->
        <div id="levelCounter">Niveau: <span id="level">1</span>/5</div>
        
        <button id="pauseBtn" onclick="pauseGame()">‚è∏Ô∏è Pause</button>
        <button id="menuBtn" onclick="goToMenu()">üè† Menu</button>
        <button id="musicBtn" onclick="toggleMusic()">üîä Musique</button>
    </div>

    <!-- √âcran Fin -->
    <div id="endScreen" class="hidden">
        <h2 id="endTitle">Bravo !</h2>
        <div class="stars" id="endStars"></div>
        <p id="endMessage" style="font-size: 2em; margin: 30px;"></p>
        <button onclick="showLevels()">Choisir un mode</button>
        <button onclick="showMenu()">Menu principal</button>
    </div>
</div>

<script>
// --- DONN√âES DES NIVEAUX ---
const phonemesData = {
    'ON': {
        icon: 'üîî', color: '#FF6B6B', words: [
            { img: 'üöö', word: 'camion', audio: 'camion.mp3' },
            { img: '‚úèÔ∏è', word: 'crayon', audio: 'crayon.mp3' },
            { img: 'üåä', word: 'ocean', audio: 'ocean.mp3' },
            { img: 'ü¶Å', word: 'lion', audio: 'lion.mp3' },
            { img: 'üè†', word: 'maison', audio: 'maison.mp3' },
            { img: 'üê∂', word: 'chien', audio: 'chien.mp3' },
            { img: 'üê±', word: 'chat', audio: 'chat.mp3' },
            { img: '‚è∞', word: 'horloge', audio: 'horloge.mp3' }
        ]
    },
    'AN': {
        icon: 'üé™', color: '#4ECDC4', words: [
            { img: 'üèñÔ∏è', word: 'sable', audio: 'sable.mp3' },
            { img: 'üêò', word: 'elephant', audio: 'elephant.mp3' },
            { img: 'üêû', word: 'coccinelle', audio: 'coccinelle.mp3' },
            { img: 'üì¶', word: 'carton', audio: 'carton.mp3' },
            { img: 'üéµ', word: 'chanson', audio: 'chanson.mp3' },
            { img: 'üöÇ', word: 'train', audio: 'train.mp3' },
            { img: 'üçé', word: 'pomme', audio: 'pomme.mp3' },
            { img: '‚òÄÔ∏è', word: 'soleil', audio: 'soleil.mp3' }
        ]
    },
    'OI': {
        icon: 'üéØ', color: '#95E1D3', words: [
            { img: 'üê∏', word: 'grenouille', audio: 'grenouille.mp3' },
            { img: 'üëë', word: 'roi', audio: 'roi.mp3' },
            { img: 'üåü', word: 'etoile', audio: 'etoile.mp3' },
            { img: 'üöó', word: 'voiture', audio: 'voiture.mp3' },
            { img: 'ü¶É', word: 'dinde', audio: 'dinde.mp3' },
            { img: 'üçå', word: 'banane', audio: 'banane.mp3' },
            { img: 'üéÅ', word: 'cadeau', audio: 'cadeau.mp3' },
            { img: 'üçì', word: 'fraise', audio: 'fraise.mp3' }
        ]
    },
    'CH': {
        icon: 'üå∏', color: '#F38181', words: [
            { img: 'üçÑ', word: 'champignon', audio: 'champignon.mp3' },
            { img: 'ü™ë', word: 'chaise', audio: 'chaise.mp3' },
            { img: 'üê¥', word: 'cheval', audio: 'cheval.mp3' },
            { img: 'üè†', word: 'maison', audio: 'maison.mp3' },
            { img: 'üêÑ', word: 'vache', audio: 'vache.mp3' },
            { img: 'üåª', word: 'tournesol', audio: 'tournesol.mp3' },
            { img: '‚è∞', word: 'horloge', audio: 'horloge.mp3' },
            { img: 'üö™', word: 'porte', audio: 'porte.mp3' }
        ]
    }
};

// URL de base pour les fichiers audio
const AUDIO_BASE_URL = 'https://atfbmx.github.io/Phoneme/audio/';

// --- √âTAT DU JEU ---
let currentPhoneme = '';
let currentWord = null;
let mode = 'fixed';
let currentLevel = 0;
let score = 0;
let lives = 3;
let gameRunning = false;
let allWordsPool = [];
let isPaused = false;
let currentObstacle = null;
let isAnswering = false;
let gameTimeout = null;
let audioElement = null;
let previousWord = null;
let obstacleSpeed = 6;
let musicElement = null;
let musicPlaying = false;

// --- MUSIQUE DE FOND ---
function toggleMusic() {
    if (!musicElement) {
        musicElement = new Audio(`${AUDIO_BASE_URL}son.mp3`);
        musicElement.loop = true;
        musicElement.volume = 0.2; // Volume plus bas pour la musique de fond
    }
    
    if (musicPlaying) {
        musicElement.pause();
        document.getElementById('musicBtn').textContent = 'üîá Musique';
        musicPlaying = false;
    } else {
        musicElement.play().catch(e => console.warn('Music play failed:', e));
        document.getElementById('musicBtn').textContent = 'üîä Musique';
        musicPlaying = true;
        updateMusicSpeed(); // Appliquer la vitesse actuelle
    }
}

function updateMusicSpeed() {
    if (musicElement && musicPlaying) {
        // VITESSE SELON LE LEVEL UNIQUEMENT (1, 2 ou 3)
        let speed = 1.0;
        if (mode === 'random') speed = 1.25; // Level 2 : +25%
        if (mode === 'expert') speed = 1.50; // Level 3 : +50%
        
        musicElement.playbackRate = speed;
        console.log('Music speed for level', mode, ':', speed);
    }
}

// --- GESTION AUDIO ROBUSTE ---
function playAudio(url) {
    if (!url) return;
    
    // Arr√™ter l'audio pr√©c√©dent
    if (audioElement) {
        try { audioElement.pause(); audioElement = null; } catch (e) {}
    }
    
    try {
        audioElement = new Audio();
        audioElement.src = url;
        audioElement.volume = 0.7;
        audioElement.onerror = () => playSystemSound(true);
        audioElement.play().catch(() => playSystemSound(true));
    } catch (e) {
        playSystemSound(true);
    }
}

function playSystemSound(isSuccess) {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode); gainNode.connect(audioContext.destination);
        oscillator.frequency.value = isSuccess ? 800 : 300;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
    } catch (e) {}
}

// --- GESTION DES √âCRANS ---
function showMenu() {
    hideAllScreens();
    document.getElementById('menuScreen').classList.remove('hidden');
}

function showLevels() {
    hideAllScreens();
    document.getElementById('levelScreen').classList.remove('hidden');
}

function showPhonemeSelection() {
    hideAllScreens();
    const grid = document.getElementById('phonemeGrid');
    grid.innerHTML = '';
    for (const [phoneme, data] of Object.entries(phonemesData)) {
        const btn = document.createElement('button');
        btn.className = 'level-btn';
        btn.innerHTML = `${data.icon} ${phoneme}`;
        btn.style.background = data.color;
        btn.onclick = () => startGame(phoneme, 'fixed');
        grid.appendChild(btn);
    }
    document.getElementById('phonemeSelectScreen').classList.remove('hidden');
}

function hideAllScreens() {
    document.querySelectorAll('#menuScreen, #levelScreen, #gameScreen, #endScreen, #phonemeSelectScreen')
        .forEach(screen => screen.classList.add('hidden'));
}

function goToMenu() {
    gameRunning = false;
    if (audioElement) { try { audioElement.pause(); } catch {} audioElement = null; }
    if (musicElement && musicPlaying) { musicElement.pause(); }
    if (gameTimeout) clearTimeout(gameTimeout);
    if (currentObstacle && currentObstacle.moveInterval) {
        clearInterval(currentObstacle.moveInterval);
        try { currentObstacle.remove(); } catch {}
        currentObstacle = null;
    }
    isAnswering = false; isPaused = false; previousWord = null;
    showMenu();
}

// --- LOGIQUE DE JEU ---
function startGame(phoneme, gameMode) {
    currentPhoneme = phoneme; mode = gameMode; currentLevel = 1; score = 0;
    lives = 3; gameRunning = true; isPaused = false; isAnswering = false;
    previousWord = null; obstacleSpeed = 6;
    
    if (mode === 'random' || mode === 'expert') {
        allWordsPool = [];
        for (const [ph, data] of Object.entries(phonemesData)) {
            data.words.forEach(w => allWordsPool.push({...w, phoneme: ph}));
        }
        allWordsPool.sort(() => Math.random() - 0.5);
    } else {
        allWordsPool = [...phonemesData[currentPhoneme].words];
    }
    
    hideAllScreens();
    document.getElementById('gameScreen').classList.remove('hidden');
    
    if (mode === 'fixed') {
        document.getElementById('phonemeDisplay').textContent = `Trouve : ${currentPhoneme}`;
        document.getElementById('phonemeDisplay').style.color = phonemesData[currentPhoneme].color;
    } else {
        document.getElementById('phonemeDisplay').textContent = `Quel son contient le mot ?`;
        document.getElementById('phonemeDisplay').style.color = '#FFD93D';
    }
    
    document.getElementById('character').style.setProperty('--character-face', '"üòê"');
    updateUI();
    
    // D√âMARRER LA MUSIQUE AUTOMATIQUEMENT
    if (!musicPlaying && musicElement) {
        toggleMusic(); // Active la musique au d√©but
    }
    updateMusicSpeed(); // Appliquer la bonne vitesse
    
    gameTimeout = setTimeout(nextObstacle, 1500);
}

function updateUI() {
    document.getElementById('lives').textContent = lives;
    document.getElementById('score').textContent = score;
    document.getElementById('level').textContent = currentLevel;
}

function getPhonemesInWord(word) {
    const phonemes = []; const lower = word.toLowerCase();
    if (lower.includes('on')) phonemes.push('ON');
    if (lower.includes('an')) phonemes.push('AN');
    if (lower.includes('oi')) phonemes.push('OI');
    if (lower.includes('ch')) phonemes.push('CH');
    return phonemes;
}

function maskPhoneme(word, phonemeToMask) {
    if (!phonemeToMask || word.length < 2) return word;
    if (mode !== 'fixed') {
        const existingPhonemes = getPhonemesInWord(word);
        if (existingPhonemes.length > 0 && !existingPhonemes.includes(phonemeToMask)) {
            phonemeToMask = existingPhonemes[0];
        }
    }
    const lowerWord = word.toLowerCase();
    const lowerPhoneme = phonemeToMask.toLowerCase();
    const index = lowerWord.indexOf(lowerPhoneme);
    if (index === -1) return word.replace(/[aeiouy]/i, '_');
    const before = word.substring(0, index);
    const after = word.substring(index + lowerPhoneme.length);
    const underscores = '_'.repeat(lowerPhoneme.length);
    return `${before}${underscores}${after}`;
}

function nextObstacle() {
    if (!gameRunning || isPaused) return;
    
    if (currentObstacle && currentObstacle.moveInterval) {
        clearInterval(currentObstacle.moveInterval);
        try { currentObstacle.remove(); } catch {}
        currentObstacle = null;
    }
    
    isAnswering = false;
    
    let attempts = 0; const maxAttempts = allWordsPool.length * 2;
    do {
        currentWord = allWordsPool[Math.floor(Math.random() * allWordsPool.length)];
        attempts++;
    } while (currentWord.word === previousWord && attempts < maxAttempts);
    
    previousWord = currentWord.word;
    
    const phonemesInWord = getPhonemesInWord(currentWord.word);
    if ((mode === 'random' || mode === 'expert') && phonemesInWord.length === 0 && attempts < maxAttempts) {
        nextObstacle(); return;
    }
    
    currentObstacle = createObstacle(currentWord, phonemesInWord);
    createAnswerButtons(phonemesInWord);
    const audioUrl = getAudioUrl(currentWord.word);
    if (audioUrl) playAudio(audioUrl); else playSystemSound(true);
}

function createObstacle(wordData, phonemesInWord) {
    const obstacle = document.createElement('div');
    obstacle.className = 'obstacle';
    obstacle.dataset.word = wordData.word;
    obstacle.dataset.phonemes = JSON.stringify(phonemesInWord);
    obstacle.dataset.correctPhoneme = mode === 'fixed' ? currentPhoneme : phonemesInWord[0];
    
    const maskedText = maskPhoneme(wordData.word, mode === 'fixed' ? currentPhoneme : phonemesInWord[0]);
    
    obstacle.innerHTML = `
        <div class="obstacle-image">${wordData.img}</div>
        <div class="masked-word">${maskedText}</div>
    `;
    
    document.getElementById('gameArea').appendChild(obstacle);
    
    let pos = window.innerWidth;
    obstacle.style.right = '-200px';
    
    const moveInterval = setInterval(() => {
        if (isPaused) return;
        pos -= obstacleSpeed;
        obstacle.style.right = (window.innerWidth - pos) + 'px';
        
        if (pos < 100 && !isAnswering) {
            clearInterval(moveInterval);
            obstacle.remove();
            currentObstacle = null;
            loseLife();
            if (lives > 0 && currentLevel < 5) {
                currentLevel++;
                updateUI();
                gameTimeout = setTimeout(nextObstacle, 1500);
            }
        }
    }, 20);
    
    obstacle.moveInterval = moveInterval;
    return obstacle;
}

function createAnswerButtons(phonemesInWord) {
    const container = document.getElementById('answerButtons');
    container.innerHTML = '';
    
    if (mode === 'fixed') {
        const btnOui = document.createElement('button');
        btnOui.className = 'answer-btn correct';
        btnOui.textContent = '‚úÖ OUI';
        btnOui.onclick = () => answer(true, currentPhoneme);
        
        const btnNon = document.createElement('button');
        btnNon.className = 'answer-btn wrong';
        btnNon.textContent = '‚ùå NON';
        btnNon.onclick = () => answer(false, null);
        
        container.appendChild(btnOui);
        container.appendChild(btnNon);
    } else {
        const options = ['ON', 'AN', 'OI', 'CH', '‚äò Aucun'];
        const shuffled = [...options].sort(() => Math.random() - 0.5);
        
        shuffled.forEach(option => {
            const btn = document.createElement('button');
            btn.className = 'answer-btn';
            
            if (option === '‚äò Aucun') {
                btn.textContent = option;
                btn.className += phonemesInWord.length === 0 ? ' correct' : ' wrong';
                btn.onclick = () => answer(phonemesInWord.length === 0, null);
            } else {
                btn.textContent = option;
                btn.style.background = phonemesData[option].color;
                btn.className += phonemesInWord.includes(option) ? ' correct' : ' wrong';
                btn.onclick = () => answer(phonemesInWord.includes(option), option);
            }
            
            container.appendChild(btn);
        });
    }
}

function answer(isCorrect, selectedPhoneme) {
    if (!currentObstacle || isAnswering) return;
    isAnswering = true;
    clearInterval(currentObstacle.moveInterval);
    
    const actualPhonemes = JSON.parse(currentObstacle.dataset.phonemes);
    const correct = mode === 'fixed'
        ? (isCorrect && actualPhonemes.includes(currentPhoneme)) || (!isCorrect && !actualPhonemes.includes(currentPhoneme))
        : actualPhonemes.includes(selectedPhoneme);
    
    if (correct) {
        score += mode === 'fixed' ? 25 : 30;
        document.getElementById('character').style.setProperty('--character-face', '"üòä"');
        playAudio('https://atfbmx.github.io/Phoneme/audio/success.mp3');
        showFeedback('‚ú® SUPER !', '#4CAF50');
        document.getElementById('character').style.bottom = '250px';
        setTimeout(() => { 
            document.getElementById('character').style.bottom = '120px';
            setTimeout(() => document.getElementById('character').style.setProperty('--character-face', '"üòê"'), 500);
        }, 400);
    } else {
        document.getElementById('character').style.setProperty('--character-face', '"üò¢"');
        playAudio('https://atfbmx.github.io/Phoneme/audio/fail.mp3');
        loseLife();
    }
    
    updateUI();
    setTimeout(() => proceedToNext(), 1800);
}

function proceedToNext() {
    if (currentObstacle) {
        try { currentObstacle.remove(); } catch {}
        currentObstacle = null;
    }
    
    if (lives <= 0) {
        endGame(false);
    } else if (currentLevel >= 5) {
        if (mode === 'fixed') {
            alert('üéâ Niveau 1 termin√© ! Passe au niveau 2 !');
            startGame(null, 'random');
        } else if (mode === 'random') {
            alert('üéâ Niveau 2 termin√© ! Passe au niveau 3 !');
            startGame(null, 'expert');
        } else {
            endGame(true);
        }
    } else {
        currentLevel++;
        updateUI();
        gameTimeout = setTimeout(nextObstacle, 1500);
    }
}

function loseLife() {
    lives--;
    showFeedback('‚ùå Mauvais !', '#F44336');
    document.getElementById('character').style.opacity = '0.3';
    setTimeout(() => { 
        document.getElementById('character').style.opacity = '1';
        setTimeout(() => document.getElementById('character').style.setProperty('--character-face', '"üòê"'), 300);
    }, 500);
}

function showFeedback(text, color) {
    const feedback = document.getElementById('feedback');
    if (feedback) feedback.remove();
    const newFeedback = document.createElement('div');
    newFeedback.id = 'feedback';
    newFeedback.textContent = text;
    newFeedback.style.color = color;
    document.getElementById('gameScreen').appendChild(newFeedback);
    setTimeout(() => newFeedback.remove(), 800);
}

function endGame(won) {
    gameRunning = false;
    if (audioElement) { try { audioElement.pause(); } catch {} audioElement = null; }
    if (gameTimeout) clearTimeout(gameTimeout);
    
    hideAllScreens();
    document.getElementById('endScreen').classList.remove('hidden');
    
    const stars = Math.floor(score / 50);
    document.getElementById('endStars').textContent = '‚≠ê'.repeat(Math.min(stars, 5));
    
    if (won) {
        document.getElementById('endTitle').textContent = 'üéâ VICTOIRE !';
        document.getElementById('endMessage').textContent = 'Ma√Ætre des phon√®mes !';
    } else {
        document.getElementById('endTitle').textContent = 'üíî Perdu...';
        document.getElementById('endMessage').textContent = `Score: ${score}. R√©essaie !`;
    }
}

function pauseGame() {
    if (!gameRunning || !currentObstacle) return;
    
    isPaused = !isPaused;
    document.getElementById('pauseBtn').textContent = isPaused ? '‚ñ∂Ô∏è Reprendre' : '‚è∏Ô∏è Pause';
    
    if (isPaused) {
        if (audioElement) { try { audioElement.pause(); } catch {} }
        if (currentObstacle.moveInterval) clearInterval(currentObstacle.moveInterval);
        if (gameTimeout) clearTimeout(gameTimeout);
    } else {
        if (audioElement) { try { audioElement.play(); } catch {} }
        let pos = window.innerWidth - parseInt(currentObstacle.style.right || 0);
        const moveInterval = setInterval(() => {
            if (isPaused) return;
            pos -= obstacleSpeed;
            currentObstacle.style.right = (window.innerWidth - pos) + 'px';
            if (pos < 100 && !isAnswering) {
                clearInterval(moveInterval);
                currentObstacle.remove();
                currentObstacle = null;
                loseLife();
                if (lives > 0) {
                    currentLevel++;
                    updateUI();
                    gameTimeout = setTimeout(nextObstacle, 1500);
                }
            }
        }, 20);
        currentObstacle.moveInterval = moveInterval;
    }
}

// --- INITIALISATION ---
showMenu();
</script>
</body>
</html>
